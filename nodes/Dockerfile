# Base image - Using latest MongoDB version
FROM mongo:latest

# Copy the initiation script into the container
COPY generate-keyfile.sh /generate-keyfile.sh

# Make the script executable
RUN chmod +x /generate-keyfile.sh

ARG REPLICA_SET_NAME

# Add healthcheck
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
  CMD mongosh --eval "db.adminCommand('ping')" || exit 1

# Expose standard MongoDB port
EXPOSE 27017

ENTRYPOINT ["/bin/bash", "-c", "/generate-keyfile.sh && exec docker-entrypoint.sh mongod --replSet $REPLICA_SET_NAME --auth --keyFile /data/keyfile --ipv6 --bind_ip ::,0.0.0.0 --wiredTigerCacheSizeGB 0.25"]
